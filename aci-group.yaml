apiVersion: 2021-09-01
location: ${ACI_REGION}
name: ${ACI_GROUP_NAME}

properties:
  osType: Linux
  restartPolicy: Always

  imageRegistryCredentials:
    - server: ${ACR_SERVER}
      username: ${ACR_USERNAME}
      password: ${ACR_PASSWORD}

  containers:
    - name: mysql
      properties:
        image: ${ACR_SERVER}/mysql:8.0
        resources:
          requests:
            cpu: 1
            memoryInGB: 1.5
        environmentVariables:
          - name: MYSQL_ROOT_PASSWORD
            value: ${DB_PASSWORD}
          - name: MYSQL_DATABASE
            value: ${DB_NAME}
        volumeMounts:
          - name: mysql-volume
            mountPath: /var/lib/mysql

    - name: django
      properties:
        image: ${ACR_SERVER}/${IMAGE_NAME}:${IMAGE_TAG}
        ports:
          - port: 9000
        resources:
          requests:
            cpu: 1
            memoryInGB: 2
        environmentVariables:
          - name: DB_HOST
            value: 127.0.0.1
          - name: DB_PORT
            value: "3306"
          - name: DB_NAME
            value: ${DB_NAME}
          - name: DB_USER
            value: root
          - name: DB_PASSWORD
            value: ${DB_PASSWORD}
          - name: SECRET_KEY
            value: ${SECRET_KEY}

  ipAddress:
    type: Public
    dnsNameLabel: onlineshopsite
    ports:
      - protocol: tcp
        port: 9000

  volumes:
    - name: mysql-volume
      azureFile:
        shareName: ${FILE_SHARE_NAME}
        storageAccountName: ${STORAGE_ACCOUNT}
        storageAccountKey: ${STORAGE_KEY}